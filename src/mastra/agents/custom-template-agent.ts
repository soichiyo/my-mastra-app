import { config } from "dotenv";
import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore, LibSQLVector } from "@mastra/libsql";
import { fastembed } from "@mastra/fastembed";
import { anthropic } from "@ai-sdk/anthropic";

// .envファイルを読み込み
config();

// カスタムワーキングメモリテンプレートを持つメモリ設定
const memory = new Memory({
  storage: new LibSQLStore({
    url: "file:../../memory.db", // .mastra/outputディレクトリからの相対パス
  }), // メッセージ履歴のストレージ
  vector: new LibSQLVector({
    connectionUrl: "file:../../vector.db", // .mastra/outputディレクトリからの相対パス
  }), // セマンティック検索用のベクトルデータベース
  embedder: fastembed, // メッセージ埋め込み用のエンベッダー
  options: {
    lastMessages: 20, // 最新20メッセージを保持
    semanticRecall: {
      topK: 3, // 上位3件の類似メッセージを取得
      messageRange: {
        before: 2, // マッチ前の2メッセージを含める
        after: 1, // マッチ後の1メッセージを含める
      },
    },
    workingMemory: {
      enabled: true, // ワーキングメモリを有効化
      // カスタムワーキングメモリテンプレート
      template: `
# ユーザープロフィール

## 個人情報

- 名前:
- 場所:
- タイムゾーン:
- 職業:
- 会社:

## 好み

- コミュニケーションスタイル: [例: フォーマル、カジュアル]
- 技術レベル: [例: 初心者、中級者、上級者]
- 回答の長さ: [例: 簡潔、詳細]
- 言語: [例: 日本語、英語]
- 興味:
- 好きなトピック:

## 現在の状況

- アクティブなプロジェクト:
- 現在の目標:
- 最近の成果:
- 未完了のタスク:

## セッション状態

- 現在のトピック:
- 未解決の質問:
  - [質問1]
  - [質問2]
- 会話の履歴:
  - [重要なポイント1]
  - [重要なポイント2]

## 専門知識

- スキル:
- 専門分野:
- 経験年数:
- 得意分野:

## 学習・成長

- 学習目標:
- 現在学習中の内容:
- 課題や困難:
- サポートが必要な領域:
      `,
    },
  },
});

// カスタムテンプレートを持つエージェントを作成
export const customTemplateAgent = new Agent({
  name: "CustomTemplateAgent",
  instructions: `
    あなたは高度なメモリ機能を持つアシスタントです。
    過去の会話とユーザーの好みを記憶できます。
    
    重要: ユーザーに関する永続的な情報を保存するためのワーキングメモリにアクセスできます。
    ユーザーについて重要なことを学んだら、提供されたテンプレートに従ってワーキングメモリを更新してください。
    
    テンプレートの使用方法：
    1. 個人情報セクション: 名前、場所、職業などの基本情報
    2. 好みセクション: コミュニケーションスタイル、技術レベル、興味
    3. 現在の状況セクション: プロジェクト、目標、タスク
    4. セッション状態セクション: 現在のトピック、未解決の質問
    5. 専門知識セクション: スキル、専門分野、経験
    6. 学習・成長セクション: 学習目標、課題、サポートが必要な領域
    
    ワーキングメモリの更新ルール：
    - ユーザーが新しい情報を提供したら、適切なセクションに保存
    - 既存の情報が更新されたら、古い情報を新しい情報で置き換え
    - 重要な会話のポイントをセッション状態に記録
    - 未解決の質問を追跡し、適切なタイミングでフォローアップ
    
    応答のガイドライン：
    - ユーザーが既に提供した情報について質問する前に、常にワーキングメモリを参照
    - ワーキングメモリの情報を使用して、パーソナライズされた応答を提供
    - ユーザーの好みに合わせて応答スタイルを調整
    - 技術レベルに応じた説明の詳細度を調整
    - 未解決の質問がある場合は、適切なタイミングで確認
    
    特徴：
    - 構造化された情報管理
    - 継続的なユーザー理解
    - パーソナライズされた応答
    - 効率的な会話管理
  `,
  model: anthropic("claude-3-5-sonnet-20241022"),
  memory: memory,
});
